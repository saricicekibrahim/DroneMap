var app=angular.module("droneApp",[]).controller("droneCtrl",["$scope","$http","$sce",function(e,t,o){function n(e){return Math.pow(2,-10*e)*Math.sin((e-.075)*(2*Math.PI)/.3)+1}var r=document.getElementById("popup"),a=document.getElementById("popup-content"),u=document.getElementById("popup-closer");app.config(function(e){e.resourceUrlWhitelist(["self","https://www.youtube.com/**"])}),e.videoFilter={search:""};var i=new ol.Overlay({element:r,autoPan:!0,autoPanAnimation:{duration:250}});e.filteredFusionData,e.filterMap=function(){setTimeout(function(){e.features=[],angular.forEach(e.filteredFusionData,function(t,o){e.features.push(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(e.getLatLonAsArray(t[1]),"EPSG:4326","EPSG:3857")),youtube_id:t[2],descr:t[3]}))}),e.videoMapSource.clear(),e.videoMapSource.addFeatures(e.features)},2e3)},u.onclick=function(){e.closePopup()},e.closePopup=function(){return a.innerHTML=null,i.setPosition(void 0),u.blur(),!1},e.getIframeSrc=function(e){return o.trustAsResourceUrl("https://www.youtube.com/embed/"+e)},e.view=new ol.View({center:ol.proj.transform([32.9,39.9],"EPSG:4326","EPSG:3857"),zoom:10,rotation:Math.PI/6}),e.map=new ol.Map({interactions:ol.interaction.defaults().extend([new ol.interaction.DragRotateAndZoom]),target:"map",layers:[new ol.layer.Tile({source:new ol.source.Stamen({layer:"terrain"})})],view:e.view,overlays:[i]}),e.screenBigEnough=function(){return $(window).width()>750},e.videoLayer=null,e.videoMapSource=null,e.features=[],e.fusionData=[],new ol.source.Vector({features:null});var l=[];t.get("https://www.googleapis.com/fusiontables/v1/query?sql=SELECT * FROM 1MIt8HjHPRe4_rifTaAwpK72vJ6c-oJdoa5c8Ryd7&key=AIzaSyCrjxOUtz0PEtDh9tDn6sjzObkC9dqQ1oA").then(function(t){e.fusionData=t.data.rows,l=t.data.rows,angular.forEach(e.fusionData,function(t,o){e.features.push(new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform(e.getLatLonAsArray(t[1]),"EPSG:4326","EPSG:3857")),youtube_id:t[2],descr:t[3]}))}),e.videoMapSource=new ol.source.Vector({features:e.features}),e.videoLayer=new ol.layer.Vector({source:e.videoMapSource,style:new ol.style.Style({image:new ol.style.Icon({src:"img/videoIcon.png"})})}),e.map.addLayer(e.videoLayer),e.map.getView().fit(e.videoLayer.getSource().getExtent(),e.map.getSize())});document.getElementById("popup");e.zoomToVideo=function(t){e.view.animate({center:ol.proj.fromLonLat(e.getLatLonAsArray(t)),duration:2e3,easing:n})},e.getPopupContent=function(t){return e.screenBigEnough()?t.get("descr")+"<iframe width='350' height='250' src='https://www.youtube.com/embed/"+t.get("youtube_id")+"' frameborder='0' allowfullscreen></iframe>":t.get("descr")+"<br><a href='https://www.youtube.com/watch?v="+t.get("youtube_id")+"' target='_blank'>Click for Video</a>"},e.getLatLonAsArray=function(e){var t=e.split(",");return[parseFloat(t[1]),parseFloat(t[0])]},e.map.on("click",function(t){var o=e.map.forEachFeatureAtPixel(t.pixel,function(e){return e});o?(a.innerHTML=e.getPopupContent(o),i.setPosition(t.coordinate)):e.closePopup()}),e.map.on("moveend",function(t){var o=t.map,n=o.getView().calculateExtent(o.getSize()),r=ol.proj.transform(ol.extent.getBottomLeft(n),"EPSG:3857","EPSG:4326"),a=ol.proj.transform(ol.extent.getTopRight(n),"EPSG:3857","EPSG:4326");e.fusionData=[],angular.forEach(l,function(t,o){var n=e.getLatLonAsArray(t[1]);n[0]>r[0]&&n[0]<a[0]&&n[1]>r[1]&&n[1]<a[1]&&e.fusionData.push(t)}),e.$apply()})}]);